#! /bin/python3

# import libs
import argparse
import subprocess 


# Setup Command line arguments
parser = argparse.ArgumentParser()
parser.add_argument("-r", "--root", help="The Path where root is mounted to.", metavar="/mnt/root", default=argparse.SUPPRESS, required=True, nargs=1)
parser.add_argument("-b", "--boot", help="The Path where boot is mounted to.", metavar="/mnt/root/boot", default=argparse.SUPPRESS, required=True, nargs=1)
parser.add_argument("-e", "--efi", help="The Path where EFI is mounted to.", metavar="/mnt/root/boot/efi", default=argparse.SUPPRESS, required=True, nargs=1)
parser.add_argument("-H", "--home", help="The Path where home is mounted to.", metavar="/mnt/root/home", default=None, nargs=1)
args = parser.parse_args()

# Print all command-line arguments.
print("Parsed arguments: {}".format(args))
# Get root info
root_uuid_command= subprocess.Popen(['/home/ward/pkgs/pikauwu/pkg-pikainstall/pikainstall/usr/lib/pika/pikainstall/partition-helper.sh', 'uuid'] + args.root, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
root_uuid = root_uuid_command.stdout.readline().decode("utf-8").strip()
root_encrypt_command = subprocess.Popen(['/home/ward/pkgs/pikauwu/pkg-pikainstall/pikainstall/usr/lib/pika/pikainstall/partition-helper.sh', 'encrypt'] + args.root, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
root_encrypt = root_encrypt_command.stdout.readline().decode("utf-8").strip()
print("Root UUID: {}".format(root_uuid))  
if root_encrypt == "luks_none":
    print("Root Encryption Device: Root is not encrypted!") 
else:
    print("Root Encryption Device: {}".format(root_encrypt))  
# Get boot info
boot_uuid_command= subprocess.Popen(['/home/ward/pkgs/pikauwu/pkg-pikainstall/pikainstall/usr/lib/pika/pikainstall/partition-helper.sh', 'uuid'] + args.boot, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
boot_uuid = boot_uuid_command.stdout.readline().decode("utf-8").strip()
print("Boot UUID: {}".format(boot_uuid))
# Get EFI info
efi_uuid_command= subprocess.Popen(['/home/ward/pkgs/pikauwu/pkg-pikainstall/pikainstall/usr/lib/pika/pikainstall/partition-helper.sh', 'uuid'] + args.efi, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
efi_uuid = efi_uuid_command.stdout.readline().decode("utf-8").strip()
print("EFI UUID: {}".format(efi_uuid))
# Get Home info is exists
if args.home is not None:
    home_uuid_command = subprocess.Popen(['/home/ward/pkgs/pikauwu/pkg-pikainstall/pikainstall/usr/lib/pika/pikainstall/partition-helper.sh', 'uuid'] + args.home, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    home_uuid = home_uuid_command.stdout.readline().decode("utf-8").strip()
    home_encrypt_command = subprocess.Popen(['/home/ward/pkgs/pikauwu/pkg-pikainstall/pikainstall/usr/lib/pika/pikainstall/partition-helper.sh', 'encrypt'] + args.home, stdout=subprocess.PIPE, stderr=subprocess.PIPE)
    home_encrypt = home_encrypt_command.stdout.readline().decode("utf-8").strip()
    print("Home UUID: {}".format(home_uuid))  
    if home_encrypt == "luks_none":
        print("Home Encryption Device: Home is not encrypted!") 
    else:
        print("Home Encryption Device: {}".format(home_encrypt))  
    
# Make sure to avoid any mounts pointing at the partition
if root_uuid == boot_uuid:
    print("Error: Root and Boot are mounted on the same drive, please place boot on it's own partition.")
    exit(1)
elif root_uuid == efi_uuid:
    print("Error: Root and EFI are mounted on the same drive, please place EFI on it's own partition.")
    exit(1)
elif boot_uuid == efi_uuid:
    print("Error: Boot and EFI are mounted on the same drive, please place each on it's own partition.")
    exit(1)
elif args.home is not None:
    if root_uuid == home_uuid:
        print("Error: Root and Home are mounted on the same drive, consider removing the -H/--home argument.")
        exit(1)
    elif boot_uuid == home_uuid:
        print("Error: Boot and Home are mounted on the same drive, consider removing the -H/--home argument.")
        exit(1)
    elif efi_uuid == home_uuid:
        print("Error: EFI and Home are mounted on the same drive, consider removing the -H/--home argument.")
        exit(1)
